name: Continuous Integration

on: pull_request

jobs:
  linter:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"
      - name: Install Dependencies
        run: npm ci
      - name: Run Linter
        run: npm run lint

  tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        test:
          - name: "unit"
          - name: "integration"
            cluster: "v5"
          - name: "integration"
            cluster: "v4"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"
      - name: Install Dependencies
        run: npm ci
      - name: Run ${{ matrix.test.name }}${{ matrix.test.cluster }} Tests and Add Annotations
        run: npm run test:${{ matrix.test.name }} -- --ci --reporters=default --reporters=github-actions --reporters=jest-junit
        env:
          CONDUCTOR_SERVER_URL: ${{ matrix.test.cluster == 'v4' && vars.SERVER_URL_V4 || vars.SERVER_URL }}
          CONDUCTOR_AUTH_KEY: ${{ matrix.test.cluster == 'v4' && secrets.AUTH_KEY_V4 || secrets.AUTH_KEY }}
          CONDUCTOR_AUTH_SECRET: ${{ matrix.test.cluster == 'v4' && secrets.AUTH_SECRET_V4 || secrets.AUTH_SECRET }}
          JEST_JUNIT_OUTPUT_NAME: ${{ matrix.test.name }}${{ matrix.test.cluster }}-test-results.xml
      - name: Publish ${{ matrix.test.name }} Test Results
        uses: dorny/test-reporter@v2
        if: ${{ !cancelled() }}
        with:
          name: ${{ matrix.test.name }} Test Report
          path: reports/${{ matrix.test.name }}${{ matrix.test.cluster }}-test-results.xml
          reporter: jest-junit
